<!DOCTYPE html>
<html>
  <head>
    <title>Twittler</title>
    <link href="main.css" type="text/css" rel="stylesheet" />
    <link href='https://fonts.googleapis.com/css?family=Lato|Merriweather' rel='stylesheet' type='text/css'>
    <script src="jquery.js"></script>
    <script src="data_generator.js"></script>
    <script src="moment.js"></script>
    <script src="livestamp.js"></script>
  </head>
  <body>
    <div class="wrapper" id="top">
      <header>
        <h1>Twittler</h1>
      </header>
      <div class="main">
        <aside>
          Current View:<br />
          <span class="user_selected">All Users</span>
        </aside>
        <div class="button-wrapper">
          <button class="refresh-button">SHOW NEW TWEETS</button>
        </div>
        <div class='tweet-section'>
          <section class="newTweets">
            <article class="form">
              <form>
                <input type="text" placeholder="What's going on?" />
                <button>Tweet</button>
              </form>
            </article>
          </section>
          <section class="content">
          </section>
        </div><!-- .tweet-section -->
      </div><!-- .main -->
      <a href="#top" id="top_link">Top</a>
      <footer>
      Robert Boggs for Hack Reactor | Twitter Clone with jQuery
      </footer>
    </div><!-- .wrapper -->
    <script>

      var currentUser = "All Users";
      var stream = streams.home;
      var index = 0;

      var showTweets = function(user) {
        var $content = $('.content');

        if (user === undefined) {
          user = "All Users";
        }

        if (user !== currentUser) {
          currentUser = user;
          index = 0;
          $content.html('');
          $('.user_selected').text(currentUser);
          stream = (user === "All Users") ? streams.home : streams.users[user.slice(1)];
        }

        while(index < stream.length) {
          var tweet = stream[index];
          var $tweet =  $('<article><span class="user">' +'@' + tweet.user
            + '</span><span class="time" data-livestamp="' + tweet.created_at.toISOString() + '">'
            + '</span><br /><span class="message">' + tweet.message
            + '</span></article>');
          $tweet.prependTo($content);
          index++;
        }

        // Set height of aside element to match content on page
        var height = $('.tweet-section').height() - 20;
        $('aside').height(height);

        $('.refresh-button').hide();

        var checkStatus = function() {
          if (index < stream.length) {
            $('.refresh-button').slideDown();
          } else {
            setTimeout(checkStatus, 3000);
          }
        }

        checkStatus();
      }

      // Event handling
      $(window).load(function(){

        showTweets();

        $(document).on('click', '.user', function() {
          var clickedUser = $(this).text();
          showTweets(clickedUser);
        });

        $('header').on('click','h1', function() {
          showTweets();
        });

        $('.refresh-button').on('click', function() {
          if (currentUser === "All Users") {
            showTweets();
          } else {
            showTweets(currentUser);
          }
        });

      });

    </script>
  </body>
</html>
